<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Wheel of Wack ‚Äî Admin</title>
    <link rel="stylesheet" href="styles/common.css" />
  </head>
  <body>
    <div class="admin-shell">
      <aside class="sidebar">
        <div class="section">
          <h3>Sessions</h3>
          <div class="row">
            <select id="sessionSelect"></select>
            <button id="loadSession">Load</button>
            <button id="deleteSession" class="danger">Delete</button>
          </div>
          <div class="row" style="margin-top:8px">
            <a href="create.html" target="_blank"><button>Open Creator</button></a>
          </div>
          <div class="row" style="margin-top:8px">
            <button id="toggleBuildTools">Hide Build Tools</button>
          </div>
        </div>
        <div class="section">
          <h3>Game Settings</h3>
          <div class="row">
            <label><span>Transparent Background (Board)</span>
              <input type="checkbox" id="transparentBg" />
            </label>
            <button id="goBoard">Go to Board</button>
            <button id="goWheel">Go to Wheel</button>
            <button id="goShop">Go to Shop</button>
          </div>

          <details style="margin-top:8px">
            <summary style="cursor:pointer">Wheel & Arrow Settings</summary>
            <div class="row" style="margin-top:8px">
              <label><span>Angled View</span>
                <input type="checkbox" id="angledView" />
              </label>
              <label><span>Angle Preset</span>
                <select id="angledPreset">
                  <option value="subtle">Subtle</option>
                  <option value="standard">Standard</option>
                  <option value="dramatic">Dramatic</option>
                  <option value="extreme">Extreme</option>
                </select>
              </label>
              <label><span>Realistic Wheel</span>
                <input type="checkbox" id="realisticWheel" />
              </label>
              <label><span>Realistic Board</span>
                <input type="checkbox" id="realisticBoard" />
              </label>
              <label><span>Vertical Slot Labels</span>
                <input type="checkbox" id="verticalLabels" />
              </label>
            </div>
            <div class="row" style="margin-top:8px">
              <label><span>Wheel Zoom</span>
                <div class="row" style="gap:6px">
                  <input type="range" id="wheelZoom" min="0.8" max="1.6" step="0.05" style="width:140px" />
                  <span id="wheelZoomVal" style="min-width:40px;text-align:right"></span>
                </div>
              </label>
              <label><span>Arrow Offset (px)</span>
                <div class="row" style="gap:6px">
                  <input type="range" id="arrowOffset" min="-120" max="120" step="1" style="width:140px" />
                  <span id="arrowOffsetVal" style="min-width:40px;text-align:right"></span>
                </div>
              </label>
            </div>
          </details>

          <details style="margin-top:8px">
            <summary style="cursor:pointer">Board Layout</summary>
            <div class="row" style="margin-top:8px">
              <label><span>Scoreboard Width (px)</span>
                <div class="row" style="gap:6px">
                  <input type="range" id="panelWidth" min="200" max="600" step="10" style="width:180px" />
                  <span id="panelWidthVal" style="min-width:48px;text-align:right"></span>
                </div>
              </label>
              <label><span>Scoreboard Zoom</span>
                <div class="row" style="gap:6px">
                  <input type="range" id="panelScale" min="0.8" max="2.5" step="0.05" style="width:180px" />
                  <span id="panelScaleVal" style="min-width:48px;text-align:right"></span>
                </div>
              </label>
               <label><span>Score Text Scale</span>
                 <div class="row" style="gap:6px">
                   <input type="range" id="scoreScale" min="0.8" max="2.0" step="0.05" style="width:180px" />
                   <span id="scoreScaleVal" style="min-width:48px;text-align:right"></span>
                 </div>
               </label>
               <label><span>Puzzle Board Scale</span>
                 <div class="row" style="gap:6px">
                   <input type="range" id="puzzleScale" min="0.6" max="2.5" step="0.05" style="width:180px" />
                   <span id="puzzleScaleVal" style="min-width:48px;text-align:right"></span>
                 </div>
               </label>
            </div>
          </details>

          <div class="row" style="margin-top:8px">
            <button id="openBoard">Open Board (current session)</button>
          </div>
        </div>

        <div class="section">
          <h3>Shop</h3>
          <div class="row" style="margin-bottom:8px">
            <label><span>Rack Theme</span>
              <select id="shopRackTheme">
                <option value="shelf">Shelves</option>
                <option value="grid">Grid</option>
                <option value="neon">Neon</option>
              </select>
            </label>
            <label><span>Shopkeeper Image</span>
              <input type="file" id="shopKeeperImage" accept="image/*" />
            </label>
            <button id="shopClearKeeper">Clear Image</button>
          </div>
          <div class="row" style="margin-bottom:8px">
            <label><span>Keeper X Offset (px)</span>
              <input type="number" id="shopKeeperOffsetX" min="-1000" max="1000" step="5" style="width:120px" />
            </label>
            <label><span>Keeper Y Offset (px)</span>
              <input type="number" id="shopKeeperOffsetY" min="-1000" max="1000" step="5" style="width:120px" />
            </label>
          </div>
          
          <div class="row" style="margin-bottom:8px">
            <label><span>Add Item (from Bonus)</span>
              <select id="shopAddBonus"></select>
            </label>
            <label><span>Price</span>
              <input type="number" id="shopAddPrice" min="0" step="10" style="width:120px" />
            </label>
            <button id="shopAddBtn">Add to Shop</button>
          </div>
          <div id="shopItemsList" class="list"></div>
        </div>

        <div class="section">
          <h3>Players</h3>
          <div id="playersList" class="list"></div>
          <div class="row" style="margin-top:8px;">
            <input type="text" id="newPlayerName" placeholder="New player name" />
            <button id="addPlayer">Add</button>
          </div>
        </div>

        <div class="section">
          <h3>Active Player</h3>
          <select id="activePlayer"></select>
          <div class="row" style="margin-top:8px">
            <button id="nextPlayer">Next Player</button>
          </div>
        </div>

        

        <div class="section">
          <h3>Bonus Items</h3>
          <div class="row">
            <input type="text" id="bonusName" placeholder="Name" />
            <input type="file" id="bonusImage" accept="image/*" />
            <input type="text" id="bonusEmoji" placeholder="Emoji (optional)" style="width:140px" />
            <button id="addBonus">Add</button>
          </div>
          <div class="row" id="bonusEmojiQuick" style="gap:6px;margin-top:6px">
            <span style="color:var(--muted);font-size:12px">Quick picks:</span>
            <button data-emo="üéâ">üéâ</button>
            <button data-emo="üçÄ">üçÄ</button>
            <button data-emo="üî•">üî•</button>
            <button data-emo="‚≠ê">‚≠ê</button>
            <button data-emo="üç∫">üç∫</button>
            <button data-emo="üéØ">üéØ</button>
            <button data-emo="üí•">üí•</button>
            <button data-emo="üçÜ">üçÜ</button>
          </div>
          <div id="bonusList" class="list" style="margin-top:8px"></div>
        </div>

        

      </aside>
      <main class="content">
        <div class="section" id="quickControls">
          <h3>Quick Controls</h3>
          <div class="row" style="margin-bottom:6px;gap:10px">
            <button id="spinWheelQuick" class="primary">Spin Wheel</button>
            <button id="revealAllBtn">Reveal Puzzle</button>
          </div>
        </div>
        <div class="section" id="resolvableBox">
          <h3>Resolvable Actions</h3>
          <div class="row" style="margin-bottom:6px">
            <label><span>Delayed resolvable actions</span>
              <input type="checkbox" id="delayedActions" />
            </label>
            <label><span>Delay scoring points</span>
              <input type="checkbox" id="delayedPoints" />
            </label>
            <span id="pendingCount" style="color:var(--muted)"></span>
          </div>
          <div id="pendingSlot" class="list"></div>
        </div>
        <div class="section">
          <h3>Guess Letter</h3>
          <div class="row">
            <input type="text" id="guessInput" maxlength="1" style="width:64px;text-transform:uppercase" />
            <button id="guessBtn" class="primary">Reveal</button>
          </div>
          <div class="row" style="margin-top:8px;gap:6px;flex-wrap:wrap" id="letterButtons"></div>
        </div>
        <div class="section">
          <h3>Buy Vowels</h3>
          <div class="row">
            <label><span>Player</span>
              <select id="vowelPlayer"></select>
            </label>
            <label><span>Cost per vowel</span>
              <input type="number" id="vowelCost" value="250" min="0" style="width:100px" />
            </label>
          </div>
          <div class="row" id="vowelButtons" style="margin-top:8px;gap:6px;flex-wrap:wrap"></div>
        </div>
        <div class="section">
          <h3>Puzzles</h3>
          <div class="row">
            <input type="text" id="pzCategory" placeholder="Category" />
            <input type="text" id="pzPhrase" placeholder="Phrase (letters only will hide)" />
            <button id="addPuzzle">Add Puzzle</button>
          </div>
          <div id="puzzles" class="list" style="margin-top:8px"></div>
          <div class="row" style="margin-top:8px">
            <button id="nextPuzzle">Next Puzzle</button>
          </div>
        </div>

        <div class="section">
          <h3>Wheel Editor</h3>
          <div class="row">
            <label><span>Slots</span>
              <input type="number" id="slotCount" min="2" max="48" />
            </label>
            <button id="applySlotCount">Apply Count</button>
            <button id="randomizeBonus">Randomize Bonus Items on Number Slots</button>
          </div>
          <div class="row" style="margin-top:8px">
            <button id="spinWheel" class="primary">Spin Wheel</button>
            <span id="spinResult" style="color:var(--muted)"></span>
            <label><span>Points per letter</span>
              <input type="number" id="resultOverride" min="0" step="10" style="width:120px" />
            </label>
          </div>
          <div id="slots" class="list" style="margin-top:8px"></div>
        </div>
      </main>
    </div>

    <script type="module">
      const deepClone = (o) => (typeof structuredClone==='function' ? structuredClone(o) : JSON.parse(JSON.stringify(o)));
      import {
        State,
        revealLetter,
        setActivePlayer,
        toggleWheel,
        toggleShop,
        toggleTransparent,
        addBonusItem,
        awardBonusToPlayer,
        removeBonusFromPlayer,
        setPlayers,
        setWheel,
        randomizeBonusOnWheel,
        startSpin,
        finishSpin,
        advancePlayer,
        currentPuzzleText,
        listSessions,
        loadSessionState,
        deleteSession,
        addPuzzle,
        setCurrentPuzzle,
        buyVowel,
        addShopItem,
        updateShopItemPrice,
        removeShopItem,
        setShopStyle,
        addPendingAction,
        resolvePendingAction,
              revealAll,
              setResultOverride,
      } from './scripts/state.js';

      const state = new State();

      // Elements
      const elTransparent = document.getElementById('transparentBg');
      const elToggleBuild = document.getElementById('toggleBuildTools');
      const elGoBoard = document.getElementById('goBoard');
      const elGoWheel = document.getElementById('goWheel');
      const elAngledView = document.getElementById('angledView');
      const elAngledPreset = document.getElementById('angledPreset');
      const elRealisticWheel = document.getElementById('realisticWheel');
      const elRealisticBoard = document.getElementById('realisticBoard');
      const elVerticalLabels = document.getElementById('verticalLabels');
      const elGoShop = document.getElementById('goShop');
      const elShopRackTheme = document.getElementById('shopRackTheme');
      const elShopKeeperImage = document.getElementById('shopKeeperImage');
      const elShopClearKeeper = document.getElementById('shopClearKeeper');
      const elShopKeeperOffsetX = document.getElementById('shopKeeperOffsetX');
      const elShopKeeperOffsetY = document.getElementById('shopKeeperOffsetY');
      const elShopAddBonus = document.getElementById('shopAddBonus');
      const elShopAddPrice = document.getElementById('shopAddPrice');
      const elShopAddBtn = document.getElementById('shopAddBtn');
      const elShopItemsList = document.getElementById('shopItemsList');
      const elWheelZoom = document.getElementById('wheelZoom');
      const elWheelZoomVal = document.getElementById('wheelZoomVal');
      const elArrowOffset = document.getElementById('arrowOffset');
      const elArrowOffsetVal = document.getElementById('arrowOffsetVal');
      const elOpenBoard = document.getElementById('openBoard');
      const elSpinWheelQuick = document.getElementById('spinWheelQuick');
      const elRevealAll = document.getElementById('revealAllBtn');
      const elDelayedActions = document.getElementById('delayedActions');
      const elDelayedPoints = document.getElementById('delayedPoints');
      const elPendingCount = document.getElementById('pendingCount');
      const elPendingSlot = document.getElementById('pendingSlot');
      const elPanelWidth = document.getElementById('panelWidth');
      const elPanelWidthVal = document.getElementById('panelWidthVal');
      const elPanelScale = document.getElementById('panelScale');
      const elPanelScaleVal = document.getElementById('panelScaleVal');
      const elScoreScale = document.getElementById('scoreScale');
      const elScoreScaleVal = document.getElementById('scoreScaleVal');
      const elPuzzleScale = document.getElementById('puzzleScale');
      const elPuzzleScaleVal = document.getElementById('puzzleScaleVal');
      const elSessionSelect = document.getElementById('sessionSelect');
      const elLoadSession = document.getElementById('loadSession');
      const elDeleteSession = document.getElementById('deleteSession');
      const elPlayersList = document.getElementById('playersList');
      const elNewPlayerName = document.getElementById('newPlayerName');
      const elAddPlayer = document.getElementById('addPlayer');
      const elActivePlayer = document.getElementById('activePlayer');
      const elNextPlayer = document.getElementById('nextPlayer');
      const elGuessInput = document.getElementById('guessInput');
      const elGuessBtn = document.getElementById('guessBtn');
      const elLetterButtons = document.getElementById('letterButtons');
      const elBonusName = document.getElementById('bonusName');
      const elBonusImage = document.getElementById('bonusImage');
      const elBonusEmoji = document.getElementById('bonusEmoji');
      const elBonusEmojiQuick = document.getElementById('bonusEmojiQuick');
      const elAddBonus = document.getElementById('addBonus');
      const elBonusList = document.getElementById('bonusList');
      const elVowelPlayer = document.getElementById('vowelPlayer');
      const elVowelCost = document.getElementById('vowelCost');
      const elVowelButtons = document.getElementById('vowelButtons');
      const elPzCategory = document.getElementById('pzCategory');
      const elPzPhrase = document.getElementById('pzPhrase');
      const elAddPuzzle = document.getElementById('addPuzzle');
      const elPuzzles = document.getElementById('puzzles');
      const elNextPuzzle = document.getElementById('nextPuzzle');
      const elSlotCount = document.getElementById('slotCount');
      const elApplySlotCount = document.getElementById('applySlotCount');
      const elRandomizeBonus = document.getElementById('randomizeBonus');
      const elSlots = document.getElementById('slots');
      const elSpinWheel = document.getElementById('spinWheel');
      const elSpinResult = document.getElementById('spinResult');
      const elResultOverride = document.getElementById('resultOverride');

      function renderSettings(s) {
        elTransparent.checked = !!s.settings.transparentBg;
        elAngledView.checked = !!s.settings.angledView;
        elRealisticWheel.checked = !!s.settings.realisticWheel;
        elRealisticBoard.checked = !!s.settings.realisticBoard;
        elAngledPreset.value = s.settings.angledPreset || 'standard';
        const z = Number(s.settings.wheelZoom || 1).toFixed(2);
        elWheelZoom.value = z;
        elWheelZoomVal.textContent = `${z}x`;
        const ao = Math.round(s.settings.wheelPointerOffset || 0);
        elArrowOffset.value = ao;
        elArrowOffsetVal.textContent = `${ao}px`;
        elVerticalLabels.checked = !!s.settings.wheelVerticalLabels;
        const pw = Math.round(s.settings.playersPanelWidth || 300);
        elPanelWidth.value = pw;
        elPanelWidthVal.textContent = `${pw}px`;
        const ps = Number(s.settings.playersPanelScale || 1).toFixed(2);
        elPanelScale.value = ps;
        elPanelScaleVal.textContent = `${ps}x`;
        const sc = Number(s.settings.playersScoreScale || 1).toFixed(2);
        elScoreScale.value = sc;
        elScoreScaleVal.textContent = `${sc}x`;
        const pz = Number(s.settings.puzzleScale || 1).toFixed(2);
        if (elPuzzleScale) elPuzzleScale.value = pz;
        if (elPuzzleScaleVal) elPuzzleScaleVal.textContent = `${pz}x`;
        if (elDelayedActions) elDelayedActions.checked = !!s.settings.delayResolvableActions;
        if (elDelayedPoints) elDelayedPoints.checked = !!s.settings.delayScoringPoints;
      }

      function renderShopAdmin(s){
        const theme = (s.shop && s.shop.style && s.shop.style.rackTheme) || 'shelf';
        if (elShopRackTheme) elShopRackTheme.value = theme;
        const kx = ((s.shop && s.shop.style && s.shop.style.keeperOffsetX) || 0);
        const ky = ((s.shop && s.shop.style && s.shop.style.keeperOffsetY) || 0);
        if (elShopKeeperOffsetX) elShopKeeperOffsetX.value = kx;
        if (elShopKeeperOffsetY) elShopKeeperOffsetY.value = ky;
        if (elShopAddBonus){
          elShopAddBonus.innerHTML = '';
          const opt = document.createElement('option'); opt.value=''; opt.textContent='Select bonus';
          elShopAddBonus.appendChild(opt);
          (s.bonusItems||[]).forEach(b=>{
            const o = document.createElement('option'); o.value=b.id; o.textContent=b.name; elShopAddBonus.appendChild(o);
          });
        }
        if (elShopItemsList){
          elShopItemsList.innerHTML = '';
          (s.shop?.items||[]).forEach(it=>{
            const bi = s.bonusItems.find(x=>x.id===it.bonusId);
            const row = document.createElement('div'); row.className='list-item';
            const wrap = document.createElement('div'); wrap.className='row';
            const img = document.createElement('img'); img.src = bi?.imageDataUrl || ''; img.alt=bi?.name||''; img.style.width='40px'; img.style.height='40px'; img.style.borderRadius='6px'; img.style.border='1px solid #2a2f45'; img.style.objectFit='cover';
            const name = document.createElement('strong'); name.textContent = bi?.name || it.bonusId;
            const price = document.createElement('input'); price.type='number'; price.min='0'; price.step='10'; price.value = it.price || 0; price.style.width='120px';
            price.addEventListener('change', ()=> state.set(st=> updateShopItemPrice(st, it.id, parseInt(price.value||'0',10)||0)) );
            const rm = document.createElement('button'); rm.className='danger'; rm.textContent='Remove';
            rm.addEventListener('click', ()=> state.set(st=> removeShopItem(st, it.id)) );
            wrap.appendChild(img); wrap.appendChild(name); wrap.appendChild(price); wrap.appendChild(rm);
            row.appendChild(wrap); elShopItemsList.appendChild(row);
          });
        }
      }

      function renderSessionsUI() {
        const sessions = listSessions();
        const curId = state.get().settings.sessionId;
        elSessionSelect.innerHTML = '';
        sessions.forEach((sess)=>{
          const o = document.createElement('option');
          o.value = sess.id;
          o.textContent = sess.name || sess.id;
          if (sess.id === curId) o.selected = true;
          elSessionSelect.appendChild(o);
        });
      }

      function renderPlayers(s) {
        elPlayersList.innerHTML = '';
        s.players.forEach((p, idx) => {
          const div = document.createElement('div');
          div.className = 'list-item';
          const row = document.createElement('div');
          row.className = 'row';
          const name = document.createElement('input');
          name.type = 'text';
          name.value = p.name;
          name.addEventListener('change', () => {
            const next = deepClone(s.players);
            next[idx].name = name.value || `Player ${idx+1}`;
            state.set((st)=> setPlayers(st, next));
          });
          const score = document.createElement('input');
          score.type = 'number';
          score.value = p.score;
          score.style.width='100px';
          score.addEventListener('change', () => {
            const next = deepClone(s.players);
            next[idx].score = parseInt(score.value||'0',10) || 0;
            state.set((st)=> setPlayers(st, next));
          });
          const del = document.createElement('button');
          del.className = 'danger';
          del.textContent = 'Remove';
          del.addEventListener('click', () => {
            const next = s.players.filter(x => x.id !== p.id);
            state.set((st)=> setPlayers(st, next));
          });
          row.appendChild(name);
          row.appendChild(score);
          row.appendChild(del);
          div.appendChild(row);

          // Award bonus select
          const award = document.createElement('div');
          award.className = 'row';
          const sel = document.createElement('select');
          const none = document.createElement('option');
          none.value = '';
          none.textContent = 'Select bonus to award';
          sel.appendChild(none);
          s.bonusItems.forEach((b) => {
            const o = document.createElement('option');
            o.value = b.id;
            o.textContent = b.name;
            sel.appendChild(o);
          });
          const btn = document.createElement('button');
          btn.textContent = 'Give Bonus';
          btn.addEventListener('click', () => {
            if (!sel.value) return;
            state.set((st)=> awardBonusToPlayer(st, p.id, sel.value));
            sel.value = '';
          });
          award.appendChild(sel);
          award.appendChild(btn);
          div.appendChild(award);

          // Inventory management list with remove buttons
          if (Array.isArray(p.inventory) && p.inventory.length) {
            const invWrap = document.createElement('div');
            invWrap.className = 'row';
            invWrap.style.flexWrap = 'wrap';
            invWrap.style.gap = '8px';
            p.inventory.forEach((bid) => {
              const bi = s.bonusItems.find((x) => x.id === bid);
              const item = document.createElement('div');
              item.style.display = 'flex';
              item.style.alignItems = 'center';
              item.style.gap = '6px';
              const img = document.createElement('img');
              img.src = bi?.imageDataUrl || '';
              img.alt = bi?.name || '';
              img.style.width = '24px';
              img.style.height = '24px';
              img.style.borderRadius = '4px';
              img.style.border = '1px solid #2a2f45';
              img.style.objectFit = 'cover';
              const lbl = document.createElement('span');
              lbl.textContent = bi?.name || bid;
              const rm = document.createElement('button');
              rm.textContent = 'Remove';
              rm.className = 'danger';
              rm.addEventListener('click', () => {
                state.set((st) => removeBonusFromPlayer(st, p.id, bid));
              });
              item.appendChild(img);
              item.appendChild(lbl);
              item.appendChild(rm);
              invWrap.appendChild(item);
            });
            div.appendChild(invWrap);
          }

          elPlayersList.appendChild(div);
        });

        // Active player dropdown
        elActivePlayer.innerHTML = '';
        s.players.forEach((p) => {
          const o = document.createElement('option');
          o.value = p.id; o.textContent = p.name;
          if (p.id === s.activePlayerId) o.selected = true;
          elActivePlayer.appendChild(o);
        });

        // Vowel buyer dropdown (defaults to active player)
        elVowelPlayer.innerHTML = '';
        s.players.forEach((p) => {
          const o = document.createElement('option');
          o.value = p.id; o.textContent = `${p.name} (Score: ${p.score})`;
          if (p.id === s.activePlayerId) o.selected = true;
          elVowelPlayer.appendChild(o);
        });
      }

      function renderLetters(s) {
        elLetterButtons.innerHTML = '';
        const vowels = new Set(['A','E','I','O','U']);
        for (let i=65;i<=90;i++){
          const L = String.fromCharCode(i);
          if (vowels.has(L)) continue; // exclude vowels from quick-guess buttons
          const b = document.createElement('button');
          b.textContent = L;
          b.disabled = s.guessedLetters.includes(L);
          b.addEventListener('click', () => {
            elGuessInput.value = L;
            elGuessBtn.click();
          });
          elLetterButtons.appendChild(b);
        }
      }

      function renderVowelSection(s) {
        elVowelButtons.innerHTML = '';
        const vowels = ['A','E','I','O','U'];
        const buyerId = elVowelPlayer.value || s.activePlayerId || (s.players[0] && s.players[0].id) || '';
        const buyer = s.players.find(p=>p.id===buyerId);
        const cost = Math.max(0, parseInt(elVowelCost.value||'250',10) || 250);
        vowels.forEach(V => {
          const b = document.createElement('button');
          b.textContent = V;
          const already = s.guessedLetters.includes(V);
          const enough = buyer ? (buyer.score >= cost) : false;
          b.disabled = already || !enough;
          b.title = !enough ? 'Insufficient score' : (already ? 'Already revealed' : '');
          b.addEventListener('click', () => {
            const pid = elVowelPlayer.value || s.activePlayerId;
            state.set(st => buyVowel(st, pid, V, cost));
          });
          elVowelButtons.appendChild(b);
        });
      }

      function renderBonus(s) {
        elBonusList.innerHTML = '';
        s.bonusItems.forEach((b) => {
          const div = document.createElement('div');
          div.className = 'list-item';
          div.innerHTML = `<div class="row"><img src="${b.imageDataUrl}" style="width:32px;height:32px;border-radius:6px;border:1px solid #2a2f45;object-fit:cover"/> <strong>${b.name}</strong></div>`;
          elBonusList.appendChild(div);
        });
      }

      function renderPuzzles(s) {
        elPuzzles.innerHTML = '';
        s.puzzles.forEach((p, idx) => {
          const div = document.createElement('div');
          div.className = 'list-item';
          const isCur = idx===s.currentPuzzleIndex;
          div.innerHTML = `<div class="row" style="justify-content:space-between;width:100%"><div><strong>${p.category}</strong> ‚Äî ${p.phrase}</div><div>${isCur?'<span style=\"color:var(--acc)\">Current</span>':`<button data-i="${idx}">Set Current</button>`}</div></div>`;
          if (!isCur) {
            div.querySelector('button')?.addEventListener('click', (e)=>{
              const i = parseInt(e.currentTarget.getAttribute('data-i'),10);
              state.set((st)=> setCurrentPuzzle(st, i));
            });
          }
          elPuzzles.appendChild(div);
        });
      }

      function renderWheel(s) {
        elSlotCount.value = s.wheel.slots.length;
        elSlots.innerHTML = '';
        if (typeof elResultOverride !== "undefined" && elResultOverride) {
          const r = s.wheelSpin && (typeof s.wheelSpin.resultOverride !== "undefined") ? s.wheelSpin.resultOverride : NaN;
          const base = parseInt(s.wheelSpin && s.wheelSpin.resultLabel ? s.wheelSpin.resultLabel : "", 10);
          const eff = Number.isFinite(r) ? r : (Number.isFinite(base) ? base : "");
          elResultOverride.value = eff === "" ? "" : String(eff);
        }
        // Spin state/result
        if (s.wheelSpin?.spinning) {
          elSpinResult.textContent = 'Spinning...';
          elSpinWheel.disabled = true;
        } else if (s.wheelSpin?.resultLabel) {
          elSpinResult.textContent = `Result: ${s.wheelSpin.resultLabel}`;
          elSpinWheel.disabled = false; if (elResultOverride) { const r = s.wheelSpin && s.wheelSpin.resultOverride; const base = parseInt(s.wheelSpin && s.wheelSpin.resultLabel ? s.wheelSpin.resultLabel : '', 10); const eff = Number.isFinite(r) ? r : (Number.isFinite(base) ? base : ''); elResultOverride.value = eff === '' ? '' : String(eff); } } else {
          elSpinResult.textContent = '';
          elSpinWheel.disabled = false;
        }
        s.wheel.slots.forEach((slot, idx) => {
          const div = document.createElement('div');
          div.className = 'list-item';
          const row1 = document.createElement('div');
          row1.className = 'row';
          const label = document.createElement('input');
          label.type = 'text'; label.value = slot.label || '';
          const color = document.createElement('input');
          color.type = 'color'; color.value = slot.color || '#3a4b8f';
          const selBonus = document.createElement('select');
          const optNone = document.createElement('option');
          optNone.value=''; optNone.textContent='No bonus';
          selBonus.appendChild(optNone);
          state.get().bonusItems.forEach((b)=>{
            const o = document.createElement('option');
            o.value=b.id; o.textContent=b.name;
            if (slot.bonusItemId===b.id) o.selected=true;
            selBonus.appendChild(o);
          });
          const save = document.createElement('button');
          save.textContent = 'Save';
          save.addEventListener('click', () => {
            const nextWheel = deepClone(state.get().wheel);
            nextWheel.slots[idx] = {
              label: label.value || '',
              color: color.value || '#3a4b8f',
              bonusItemId: selBonus.value || undefined,
            };
            state.set((st)=> setWheel(st, nextWheel));
          });
          row1.appendChild(label);
          row1.appendChild(color);
          row1.appendChild(selBonus);
          row1.appendChild(save);
          div.appendChild(row1);
          elSlots.appendChild(div);
        });
      }

      // Resolvable actions box
      function renderResolvable(s){
        if (!elPendingSlot || !elPendingCount) return;
        const list = Array.isArray(s.pendingActions) ? s.pendingActions : [];
        elPendingCount.textContent = list.length ? `(${list.length} pending)` : '';
        elPendingSlot.innerHTML = '';
        if (!list.length) {
          const div = document.createElement('div');
          div.className = 'list-item';
          div.textContent = 'No pending actions';
          elPendingSlot.appendChild(div);
          return;
        }
        const a = list[0];
        const row = document.createElement('div');
        row.className = 'list-item';
        const inner = document.createElement('div');
        inner.className = 'row';
        const actionText = (a.type === 'points') ? `Points Scored: ${a.amount}` : (a.label || a.type);
        const action = document.createElement('div');
        action.textContent = `Action to resolve: ${actionText}`;
        const t = document.createElement('div');
        const sPlayer = (s.players.find(p=>p.id===a.playerId) || {}).name || 'Unknown';
        t.textContent = `Target Player: ${sPlayer}`;
        const btn = document.createElement('button');
        btn.textContent = 'Resolve';
        btn.addEventListener('click', ()=> state.set(st => resolvePendingAction(st, a.id)) );
        inner.appendChild(action); inner.appendChild(t); inner.appendChild(btn);
        row.appendChild(inner);
        elPendingSlot.appendChild(row);
      }

      

      // Events
      elTransparent.addEventListener('change', () => {
        state.set((s)=> toggleTransparent(s, elTransparent.checked));
      });
      if (elDelayedActions) elDelayedActions.addEventListener('change', ()=>{
        state.set(s=>{ const n = deepClone(s); n.settings.delayResolvableActions = !!elDelayedActions.checked; return n; });
      });
      if (elDelayedPoints) elDelayedPoints.addEventListener('change', ()=>{
        state.set(s=>{ const n = deepClone(s); n.settings.delayScoringPoints = !!elDelayedPoints.checked; return n; });
      });
      elGoWheel.addEventListener('click', () => {
        state.set((s)=>{
          let n = deepClone(s);
          n = toggleShop(n, false);
          n = toggleWheel(n, true);
          return n;
        });
      });
      elGoBoard.addEventListener('click', () => {
        state.set((s)=>{
          let n = deepClone(s);
          n = toggleShop(n, false);
          n = toggleWheel(n, false);
          return n;
        });
      });
      elGoShop.addEventListener('click', () => {
        state.set((s)=> toggleShop(s, true));
      });
      if (elShopRackTheme) elShopRackTheme.addEventListener('change', () => {
        const v = elShopRackTheme.value || 'shelf';
        state.set(st => setShopStyle(st, { rackTheme: v }));
      });
      if (elShopKeeperImage) elShopKeeperImage.addEventListener('change', async () => {
        const f = elShopKeeperImage.files && elShopKeeperImage.files[0];
        if (!f) return;
        const url = await fileToDataUrl(f);
        state.set(st => setShopStyle(st, { keeperImageDataUrl: url }));
        elShopKeeperImage.value='';
      });
      if (elShopClearKeeper) elShopClearKeeper.addEventListener('click', () => {
        state.set(st => setShopStyle(st, { keeperImageDataUrl: '' }));
      });
      if (elShopKeeperOffsetX) elShopKeeperOffsetX.addEventListener('input', () => {
        const v = parseInt(elShopKeeperOffsetX.value||'0',10)||0;
        state.set(st => setShopStyle(st, { keeperOffsetX: v }));
      });
      if (elShopKeeperOffsetY) elShopKeeperOffsetY.addEventListener('input', () => {
        const v = parseInt(elShopKeeperOffsetY.value||'0',10)||0;
        state.set(st => setShopStyle(st, { keeperOffsetY: v }));
      });
      if (elShopRackTheme) elShopRackTheme.addEventListener('change', () => {
        const v = elShopRackTheme.value || 'shelf';
        state.set(st => setShopStyle(st, { rackTheme: v }));
      });
      if (elShopKeeperImage) elShopKeeperImage.addEventListener('change', async () => {
        const f = elShopKeeperImage.files && elShopKeeperImage.files[0];
        if (!f) return;
        const url = await fileToDataUrl(f);
        state.set(st => setShopStyle(st, { keeperImageDataUrl: url }));
        elShopKeeperImage.value='';
      });
      if (elShopClearKeeper) elShopClearKeeper.addEventListener('click', () => {
        state.set(st => setShopStyle(st, { keeperImageDataUrl: '' }));
      });
      if (elShopAddBtn) elShopAddBtn.addEventListener('click', () => {
        const bid = elShopAddBonus.value || '';
        const price = Math.max(0, parseInt(elShopAddPrice.value||'0',10)||0);
        if (!bid) return;
        state.set(st => addShopItem(st, bid, price));
        elShopAddBonus.value=''; elShopAddPrice.value='';
      });
      elAngledView.addEventListener('change', () => {
        state.set((s)=>{ const n = deepClone(s); n.settings.angledView = !!elAngledView.checked; return n; });
      });
      elRealisticWheel.addEventListener('change', () => {
        state.set((s)=>{ const n = deepClone(s); n.settings.realisticWheel = !!elRealisticWheel.checked; return n; });
      });
      elRealisticBoard.addEventListener('change', () => {
        state.set((s)=>{ const n = deepClone(s); n.settings.realisticBoard = !!elRealisticBoard.checked; return n; });
      });
      elAngledPreset.addEventListener('change', () => {
        state.set((s)=>{ const n = deepClone(s); n.settings.angledPreset = elAngledPreset.value || 'standard'; return n; });
      });
      elWheelZoom.addEventListener('input', () => {
        const v = Math.max(0.5, Math.min(2, parseFloat(elWheelZoom.value)||1));
        elWheelZoomVal.textContent = `${v.toFixed(2)}x`;
        state.set((s)=>{ const n = deepClone(s); n.settings.wheelZoom = v; return n; });
      });
      elArrowOffset.addEventListener('input', () => {
        const v = Math.max(-120, Math.min(120, parseInt(elArrowOffset.value)||0));
        elArrowOffsetVal.textContent = `${v}px`;
        state.set((s)=>{ const n = deepClone(s); n.settings.wheelPointerOffset = v; return n; });
      });
      elPanelWidth.addEventListener('input', () => {
        const v = Math.max(200, Math.min(600, parseInt(elPanelWidth.value)||300));
        elPanelWidthVal.textContent = `${v}px`;
        state.set((s)=>{ const n = deepClone(s); n.settings.playersPanelWidth = v; return n; });
      });
      elPanelScale.addEventListener('input', () => {
        const v = Math.max(0.5, Math.min(3, parseFloat(elPanelScale.value)||1));
        elPanelScaleVal.textContent = `${v.toFixed(2)}x`;
        state.set((s)=>{ const n = deepClone(s); n.settings.playersPanelScale = v; return n; });
      });
      elScoreScale.addEventListener('input', () => {
        const v = Math.max(0.5, Math.min(3, parseFloat(elScoreScale.value)||1));
        elScoreScaleVal.textContent = `${v.toFixed(2)}x`;
        state.set((s)=>{ const n = deepClone(s); n.settings.playersScoreScale = v; return n; });
      });
      if (elPuzzleScale) elPuzzleScale.addEventListener('input', () => {
        const v = Math.max(0.5, Math.min(3, parseFloat(elPuzzleScale.value)||1));
        if (elPuzzleScaleVal) elPuzzleScaleVal.textContent = `${v.toFixed(2)}x`;
        state.set((s)=>{ const n = deepClone(s); n.settings.puzzleScale = v; return n; });
      });
      if (elResultOverride) elResultOverride.addEventListener('input', ()=>{ const v = parseInt(elResultOverride.value||''); state.set(st=> setResultOverride(st, v)); });
      elVerticalLabels.addEventListener('change', () => {
        state.set((s)=>{ const n = deepClone(s); n.settings.wheelVerticalLabels = !!elVerticalLabels.checked; return n; });
      });
      if (elSpinWheelQuick) elSpinWheelQuick.addEventListener('click', () => { const durationMs = 4500; state.set(st=> startSpin(st)); setTimeout(()=> state.set(st=> finishSpin(st)), durationMs + 50); });
      if (elRevealAll) elRevealAll.addEventListener('click', () => { state.set(st => revealAll(st)); });
      elOpenBoard.addEventListener('click', () => {
        const sid = state.get().settings.sessionId;
        const url = sid ? `board.html?session=${encodeURIComponent(sid)}` : 'board.html';
        window.open(url, '_blank');
      });
      elAddPlayer.addEventListener('click', () => {
        const name = (elNewPlayerName.value || '').trim();
        const id = Math.random().toString(36).slice(2,9);
        const players = [...state.get().players, { id, name: name || `Player ${state.get().players.length+1}`, score: 0, inventory: [] }];
        state.set((st)=> setPlayers(st, players));
        elNewPlayerName.value = '';
      });
      elActivePlayer.addEventListener('change', () => {
        state.set((st)=> setActivePlayer(st, elActivePlayer.value));
      });
      elNextPlayer.addEventListener('click', () => {
        state.set((st)=> advancePlayer(st, 1));
      });
      elGuessBtn.addEventListener('click', () => {
        const v = (elGuessInput.value || '').toUpperCase();
        if (!v) return;
        const s = state.get();
        const beforeRevealed = new Set(s.revealedLetters);
        const text = currentPuzzleText(s);
        let newCount = 0;
        if (!beforeRevealed.has(v)) {
          for (const ch of text) if (ch === v) newCount++;
        }
        // Apply reveal
        state.set((st)=> revealLetter(st, v));
        // If no occurrences, emit miss event for Board overlay
        if (newCount === 0) {
          state.set(st => { const n = deepClone(st); n.ui = n.ui || {}; n.ui.lastMiss = { letter: v, at: Date.now() }; return n; });
        }
        // Award points if last spin was numeric
        const spin = s.wheelSpin || {};
        const slot = (Array.isArray(s.wheel.slots) && Number.isInteger(spin.resultIndex)) ? (s.wheel.slots[spin.resultIndex] || {}) : {};
        const baseVal = parseInt(slot.label, 10);
        const overrideVal = (s.wheelSpin && Number.isFinite(s.wheelSpin.resultOverride)) ? s.wheelSpin.resultOverride : NaN;
        const val = Number.isFinite(overrideVal) ? overrideVal : baseVal;
        if (Number.isFinite(val) && newCount > 0) {
          const delayed = !!(s.settings && s.settings.delayScoringPoints);
          if (delayed) {
            state.set(st=> addPendingAction(st, { type: 'points', amount: val * newCount, label: String(val), playerId: st.activePlayerId }));
          } else {
            state.set((st)=>{
              const next = deepClone(st);
              const ap = next.players.find((p)=> p.id === next.activePlayerId);
              if (ap) ap.score += val * newCount;
              return next;
            });
          }
        }
        elGuessInput.value = '';
        elGuessInput.focus();
      });
      elGuessInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') elGuessBtn.click();
      });
      elAddBonus.addEventListener('click', async () => {
        const name = (elBonusName.value || '').trim();
        const file = (elBonusImage.files && elBonusImage.files[0]) ? elBonusImage.files[0] : null;
        const emoji = (elBonusEmoji.value || '').trim();
        if (!name) return;
        let url = '';
        if (file) {
          url = await fileToDataUrl(file);
        } else if (emoji) {
          url = emojiToDataUrl(emoji, 64);
        } else {
          return;
        }
        const id = Math.random().toString(36).slice(2,9);
        state.set((st)=> addBonusItem(st, { id, name, imageDataUrl: url }));
        elBonusName.value = '';
        elBonusImage.value = '';
        elBonusEmoji.value = '';
      });
      elAddPuzzle.addEventListener('click', () => {
        const cat = (elPzCategory.value || '').trim();
        const phr = (elPzPhrase.value || '').trim();
        if (!cat || !phr) return;
        state.set((st)=> addPuzzle(st, { category: cat, phrase: phr }, true));
        elPzCategory.value = '';
        elPzPhrase.value = '';
      });
      elNextPuzzle.addEventListener('click', () => {
        const s = state.get();
        if (s.currentPuzzleIndex < s.puzzles.length - 1) {
          const next = deepClone(s);
          next.currentPuzzleIndex++;
          next.revealedLetters = [];
          next.guessedLetters = [];
          state.set(next);
        }
      });
      elApplySlotCount.addEventListener('click', () => {
        const n = Math.max(2, Math.min(48, parseInt(elSlotCount.value||'0',10) || 0));
        const s = state.get();
        const cur = s.wheel.slots;
        const nextSlots = Array.from({length:n}, (_,i)=> cur[i] || {
          label: String(500 + i*50),
          color: `hsl(${(i*360/n).toFixed(0)},60%,40%)`
        });
        state.set((st)=> setWheel(st, { slots: nextSlots }));
      });
      elRandomizeBonus.addEventListener('click', () => {
        state.set((st)=> randomizeBonusOnWheel(st));
      });
      elSpinWheel.addEventListener('click', () => {
        const durationMs = 4500;
        state.set((st)=> startSpin(st));
        setTimeout(() => {
          state.set((st)=> finishSpin(st));
        }, durationMs + 50);
      });

      function fileToDataUrl(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });
      }

      function emojiToDataUrl(char, size=64) {
        const safe = (char || '').substring(0,2);
        const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='${size}' height='${size}'>`+
                    `<rect width='100%' height='100%' fill='transparent'/>`+
                    `<text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-size='${Math.floor(size*0.8)}'>${safe}</text>`+
                    `</svg>`;
        return `data:image/svg+xml;utf8,${encodeURIComponent(svg)}`;
      }

      // Quick emoji clicks fill the emoji input
      elBonusEmojiQuick.addEventListener('click', (e)=>{
        const t = e.target;
        if (t && t.tagName === 'BUTTON' && t.dataset.emo) {
          elBonusEmoji.value = t.dataset.emo;
        }
      });

      function renderAll(s){
        renderSettings(s);
        renderSessionsUI();
        renderPlayers(s);
        renderLetters(s);
        renderVowelSection(s);
        renderBonus(s);
        renderPuzzles(s);
        renderWheel(s);
        renderShopAdmin(s);
        renderResolvable(s);
      }
      renderAll(state.get());
      state.subscribe(renderAll);
      // Build tools visibility toggle
      (function initBuildToolsToggle(){
        const KEY='wack-admin-tools-hidden';
        function applyHidden(hidden){
          document.body.classList.toggle('admin-tools-hidden', !!hidden);
          if (elToggleBuild) elToggleBuild.textContent = hidden ? 'Show Build Tools' : 'Hide Build Tools';
          try{ localStorage.setItem(KEY, hidden ? '1':'0'); }catch{}
        }
        let initHidden=false; try{ initHidden = localStorage.getItem(KEY)==='1'; }catch{}
        applyHidden(initHidden);
        if (elToggleBuild) elToggleBuild.addEventListener('click', ()=>{
          const nowHidden = !document.body.classList.contains('admin-tools-hidden');
          applyHidden(nowHidden);
        });
      })();
      elVowelCost.addEventListener('change', ()=> renderVowelSection(state.get()));
      elVowelPlayer.addEventListener('change', ()=> renderVowelSection(state.get()));

      // Session events
      elLoadSession.addEventListener('click', () => {
        const id = elSessionSelect.value;
        if (!id) return;
        const st = loadSessionState(id);
        if (st) state.set(st);
      });
      elDeleteSession.addEventListener('click', () => {
        const id = elSessionSelect.value;
        if (!id) return;
        if (confirm('Delete this session?')) {
          deleteSession(id);
          renderSessionsUI();
        }
      });
    </script>
  </body>
  </html>













